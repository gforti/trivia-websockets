<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel='stylesheet' href='bulma.css' />
        <style>
            
            .level {
                font-weight: bold;
                background-image: linear-gradient(141deg, #ff0561 0%, #ff3860 71%, #ff5257 100%);
                margin: 0 !important;
                padding: 1rem;
            }
            
            .login {
                text-align: center;
            }
                       
            .icons {
                display: block;
                padding: 2rem;
            }
            .icons img {
                width: 70px;
            }
            
            .icons input[type="radio"],
            .choices input[type="radio"]
            {
                display: none;
            }
            
            .icons input[type=radio] ~ img,
            .choices input[type=radio] + label{
                font-size: 2rem;
                color: white;
                padding: 0.4rem;
                margin: 0.6rem;
             }
            
            .icons input[type=radio]:checked ~ img,            
            .choices input[type=radio]:checked + label {
                background-color: red;
             }
             
             
            input:required:invalid, 
            select:required:invalid,
            textarea:required:invalid
            {
              border: 1px solid red;
            }

            input:required:valid, 
            select:required:valid,
            textarea:required:valid
            {
              border: 1px solid green;
            }
            
            
           #loading {
  background-color: #FAFAFA;
  -webkit-animation: color 8s linear infinite;
          animation: color 8s linear infinite;
} 
            
            
            #candy {
  overflow: hidden;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  opacity: 0;
  margin: calc(50vh - 150px) auto 0 auto;
  width: 100px;
  height: 300px;
  border-radius: 100px;
  border-bottom-left-radius: 0px;
  border-bottom-right-radius: 0px;
  background-color: #FAFAFA;
  -webkit-box-shadow: 40px 20px 15px -30px rgba(255, 0, 0, 0.1);
          box-shadow: 40px 20px 15px -30px rgba(255, 0, 0, 0.1);
  -webkit-transform: rotate(90deg);
          transform: rotate(90deg);
  -webkit-animation: PARTY 8s cubic-bezier(0.87, -0.41, 0.19, 1.44) infinite;
          animation: PARTY 8s cubic-bezier(0.87, -0.41, 0.19, 1.44) infinite;
}

#candy-loader {
  height: 100%;
  width: 100%;
  z-index: 1;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-align: center;
      -ms-flex-align: center;
          align-items: center;
  -ms-flex-item-align: end;
      align-self: flex-end;
  -webkit-box-shadow: 0px 0px 10px rgba(255, 50, 0, 0.8) inset;
          box-shadow: 0px 0px 10px rgba(255, 50, 0, 0.8) inset;
  background: #D33144;
  background: repeating-linear-gradient(45deg, #FFFFEE, #FFFFEE 15px, #D33144 15px, #D33144 30px);
  -webkit-animation: load 8s ease-in infinite;
          animation: load 8s ease-in infinite;
}

#candy-loader::after {
  content: "";
  background-color: #FAFAFA;
  width: 50px;
  height: 270px;
  border-radius: 50px;
  border-bottom-left-radius: 0px;
  border-bottom-right-radius: 0px;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -ms-flex-item-align: end;
      align-self: flex-end;
  -webkit-animation: color 8s linear infinite;
          animation: color 8s linear infinite;
}

#candy-loader::before {
  content: "";
  background-color: #FAFAFA;
  width: 25px;
  height: 210px;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -ms-flex-item-align: end;
      align-self: flex-end;
  -webkit-animation: color 8s linear infinite;
          animation: color 8s linear infinite;
}

@-webkit-keyframes load {
  0% {
    height: 0%;
  }
  50% {
    height: 100%;
  }
}

@keyframes load {
  0% {
    height: 0%;
  }
  50% {
    height: 100%;
  }
}

@-webkit-keyframes PARTY {
  5% {
    opacity: 1;
  }
  50% {
    -webkit-transform: rotate(90deg) scale(1);
            transform: rotate(90deg) scale(1);
  }
  60% {
    -webkit-transform: rotate(-10deg) scale(1);
            transform: rotate(-10deg) scale(1);
  }
  70% {
    -webkit-transform: rotate(20deg) scale(1);
            transform: rotate(20deg) scale(1);
  }
  80% {
    -webkit-transform: rotate(-10deg) scale(1);
            transform: rotate(-10deg) scale(1);
  }
  90% {
    -webkit-transform: rotate(30deg) scale(1);
            transform: rotate(30deg) scale(1);
    opacity: 1;
  }
  100% {
    -webkit-transform: rotate(-180deg) scale(0);
            transform: rotate(-180deg) scale(0);
    opacity: 0;
  }
}

@keyframes PARTY {
  5% {
    opacity: 1;
  }
  50% {
    -webkit-transform: rotate(90deg) scale(1);
            transform: rotate(90deg) scale(1);
  }
  60% {
    -webkit-transform: rotate(-10deg) scale(1);
            transform: rotate(-10deg) scale(1);
  }
  70% {
    -webkit-transform: rotate(20deg) scale(1);
            transform: rotate(20deg) scale(1);
  }
  80% {
    -webkit-transform: rotate(-10deg) scale(1);
            transform: rotate(-10deg) scale(1);
  }
  90% {
    -webkit-transform: rotate(30deg) scale(1);
            transform: rotate(30deg) scale(1);
    opacity: 1;
  }
  100% {
    -webkit-transform: rotate(-180deg) scale(0);
            transform: rotate(-180deg) scale(0);
    opacity: 0;
  }
}

@-webkit-keyframes color {
  55% {
    background-color: #FAFAFA;
  }
  57% {
    background-color: #31D354;
  }
  95% {
    background-color: #31D354;
  }
}

@keyframes color {
  55% {
    background-color: #FAFAFA;
  }
  57% {
    background-color: #31D354;
  }
  95% {
    background-color: #31D354;
  }
}

        </style>
    </head>
    <body>
               
        <section class="hero is-success is-fullheight">
            <div class="hero-head">
            <nav class="level is-mobile">         
                <div class="level-item has-text-centered currentUser"></div> 
                <div class="level-item has-text-centered points"></div>
                <div class="level-item has-text-centered numUsers"></div>                 
            </nav>
            
            
                <div class="login">
                    <div class="section">
                        <h1 class="title">User Name</h1>
                        <input name="user" type="text" class="input is-large" required />
                        <div class="icons"></div>
                        <button class="button is-primary is-large login">Enter</button>
                    </div>
                </div>

                <div class="game is-hidden">   
                    
                    <div id='candy' class="is-hidden">
                        <div id='candy-loader'></div>
                    </div>
                    
                    <div class="section game-start is-hidden has-text-centered">                       
                        <progress class="progress is-large is-info" value="100" max="100"></progress>
                        
                        <div class="choices">
                            
                        </div>
                        
                        <p>
                        <button class="submitChoice button is-large is-danger">Submit</button>
                        </p>
                    </div>
                    

                </div>
                
                
            
            </div>
        </section>
        
        <script src="/socket.io/socket.io.js"></script>
        <script>
            
            
            
            
             var socket = io();
             let username, connected, userid;
             document.querySelector('button.login').addEventListener('click', setUsername)  
             
             let choiceButton = document.querySelector('button.submitChoice');
             choiceButton.addEventListener('click', submitChoice)            
              choiceButton.classList.add('is-hidden')
             
             let choices = document.querySelector('.choices')
             let progress = document.querySelector('progress')
             
             let progressTimer = null
             
                      
             
             document.querySelector('div.icons').innerHTML = (function(){
                 let html = '';
                 let autoSelect = Math.floor(Math.random() * 24) + 1  
                 
                 for( let i = 1; i < 24; i++ ) {
                     let icon = `icons/${i}.png`
                     html += `<label for="${icon}">
                                <input  type="radio" 
                                        name="icon" 
                                        value="${icon}" 
                                        id="${icon}"
                                        ${ autoSelect === i ? 'checked' : ''}
                                > 
                                <img src="${icon}"/> 
                            </label>`
                 }
                 return html
             })()
             
             
              function setUsername () {
                username = document.querySelector('input[name="user"]');
                icon = document.querySelector('input[name="icon"]:checked').value;
                

                // If the username is valid
                if (username.checkValidity()) {                 
                  // Tell the server your username
                  username = username.value
                  socket.emit('add user', {username, icon});
                  setCurrentUser({username, icon})
                  hide('.login')
                  
                  window.scrollTo(0, 0);
                }
              }
              
              
              // Whenever the server emits 'login', log the login message
            socket.on('login', function (data) {
                connected = true;

                userid = data.userid
                updateUsers(data)
                updatePoints(null)
                show('.game')
                // used to allow late joins without breaking the game
                if (!data.gameInProgress){                    
                    show('#candy')
                    document.querySelector('section.hero').id = 'loading'
                } else {
                    document.querySelector('section.hero').id = ''
                    hide('#candy')
                    show('.game-start')
                    socket.emit('question timer')
                }
            });
            
            // Whenever the server emits 'user joined', log it in the chat body
            socket.on('user joined', function (data) {
                updateUsers(data)                
            });
            
            
             socket.on('question', function (data) {             
               
                document.querySelector('section.hero').id = ''
                hide('#candy')
                show('.game-start')
                
                progressTimer = null                
                progress.value = 100;
                updateProgressBar(data)
                displayChoices(data)
                
            });
            
            
             socket.on('answer results', function (data) {
                updatePoints(data)
                displayIfCorrect(data)
            });
            
            
            function displayIfCorrect(data) {
                choices.innerHTML = `<h1 class="${data[userid].correct ? 'is-info' : 'is-danger'} title is-1">
                        ${data[userid].correct ? 'Correct' : 'Wrong Answer'}
                        </h1>`
            }
            
            function submitChoice(){
                let answer = document.querySelector('input[name="answer"]:checked').value;
                
                if (answer) {                    
                    socket.emit('answer', {answer});
                    closeChoice()
                }
                
            }
            
            function closeChoice() {
                choiceButton.classList.add('is-hidden')
                choices.innerHTML = ''  
            }

            function displayChoices(data){
                
                choices.innerHTML = ''
                if ( data.choices && data.choices.length ) {
                     choiceButton.classList.remove('is-hidden')
                     let html = '<ul>';
                 
                    for( let i = 0; i <  data.choices.length; i++ ) {
                     let answer = data.choices[i]
                     html += `<li>
                                <input  type="radio" 
                                        name="answer" 
                                        value="${answer}" 
                                        id="${answer}"
                                > <label for="${answer}" class="label">
                                ${answer} 
                            </label></li>`
                     }
                     html += '</ul>'
                     choices.innerHTML = html
                }
            }

            function updateProgressBar(data){
                
                let now = new Date().getTime();
                var pct = Math.floor(100 * (data.endTime - now) / data.totalTime);
                if (pct < 2 || isNaN(pct)) {
                    pct = 0;
                }
                progress.value = pct;
                if (pct < 20) {
                   progress.classList.remove('is-info')
                   progress.classList.add('is-danger');
                } 
                if (pct < 1) {
                    // if 0 or negative, no need to update again.
                    closeChoice();
                    progress.classList.remove('is-danger')
                    progress.classList.add('is-info');
                    socket.emit('question timer')
                    return;
                }
            
               progressTimer = setTimeout(updateProgressBar.bind(this, data), 100);
                
            }

            function updateUsers(data) {
                if (data.numUsers)
                    document.querySelector('.numUsers').innerHTML = `
                        <div>
                            <p class="heading">Players</p>
                            <p class="title">${data.numUsers}</p>
                        </div> `;
            }
            
            function updatePoints(data) {           
                    document.querySelector('.points').innerHTML = `
                        <div>
                            <p class="heading">Answered</p>
                            <p class="title">${data ? data[userid].points : 0}</p>
                        </div> `;
            }
            
            function setCurrentUser(data) {
                if (data.username && data.icon)
                    document.querySelector('.currentUser').innerHTML = `
                        <div>
                            <p class="heading">${data.username}</p>
                            <p class="title"><img src="${data.icon}" class="image is-48x48" /> </p>
                        </div> `;
            }
            
            function hide(selector){
                document.querySelector(selector).classList.add('is-hidden')
            }
            
            function show(selector){
                document.querySelector(selector).classList.remove('is-hidden')
            }
        </script>
    </body>
</html>
